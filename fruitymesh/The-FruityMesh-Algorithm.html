<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FruityMesh Algorithm :: Fruitymesh</title>
  <link rel="canonical" href="http://mwaylabs.github.io/fruitymesh/fruitymesh/The-FruityMesh-Algorithm.html">
  <meta name="generator" content="Antora 2.0.0">
  <link rel="stylesheet" href="../_/css/site.css">
  <link rel="stylesheet" href="../_/css/footer.css">
<link rel="icon" type="image/png" href="../_/img/favicon.png" />
</head>

<body class="article">
  <header class="header" role="banner">
<header class="header" role="banner">
  <div class="navbar-top">
    <a class="navbar-logo" id="fruitymesh-logo-padding" href="https://mwaylabs.github.io/fruitymesh/fruitymesh/index.html">
      <div class="navbar-item">
        <img src="../_/img/fruitymesh_logo.png" alt="Fruitymesh">
      </div>
    </a>
    <div class="navbar-item">
      <div id="search-wrapper">
        <input id="search-input" type="text" placeholder="Search...">
      </div>
    </div>
  </div>
  <nav class="navbar-bottom fruitymesh-header-color">
    <a href="https://github.com/mwaylabs/fruitymesh">
      <div class="navbar-item">Fruitymesh on Github</div>
    </a>
  </nav>
</header>

</header>
  <div class="main-wrapper">
<div class="navigation-container" data-component="" data-version="master">
  <aside class="navigation" role="navigation">
    <div class="panels">
<div class="navigation-menu is-active" data-panel="menu">
  <button class="navigation-toggle"></button>
  <nav class="nav-menu">
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
    <ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="Quick-Start.html">Quick Start</a>
      </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="Usage.html">Usage</a>
      </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="Features.html">Features</a>
      </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="Developers.html">Developers</a>
      </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="Specification.html">Specification</a>
      </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="Modules.html">Modules</a>
    <ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="AdvertisingModule.html">Advertising Module</a>
      </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="DebugModule.html">Debug Module</a>
      </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="DfuModule.html">DFU Module</a>
      </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="EnrollmentModule.html">Enrollment Module</a>
      </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="IoModule.html">IO Module</a>
      </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="MeshAccessModule.html">Mesh Access Module</a>
      </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="Node.html">Node</a>
      </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="ScanningModule.html">Scanning Module</a>
      </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="StatusReporterModule.html">Status Report Module</a>
      </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <span class="nav-text">Other Classes</span>
    <ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="Logger.html">Logger</a>
      </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="RecordStorage.html">Record Storage</a>
      </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <span class="nav-text">Other</span>
    <ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="Class-Structure.html">Class Structure</a>
      </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="Debugging.html">Debugging</a>
      </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="Battery-Consumption.html">Battery Consumption</a>
      </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="RecordStorage.html">Record Storage</a>
      </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="The-FruityMesh-Algorithm.html">The Fruitymesh Algorithm</a>
    <ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="The-Algorithm-in-Detail.html">The Algorithm in Detail</a>
      </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="Simulator.html">Simulator</a>
      </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="Tutorials.html">Tutorials</a>
    <ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="Implementing-a-Custom-Module.html">Implementing a Custom Module</a>
      </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="FAQ.html">FAQ</a>
      </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="navigation-explore" data-panel="explore">
  <div class="context">
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
  <main class="main" role="main">
<article class="doc"><a name="section-top"></a>
<h1>FruityMesh Algorithm</h1>
<div class="sect1">
<h2 id="_introduction"><a class="anchor" href="#_introduction"></a>Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A mesh should be able to build and
manage all connections without user interaction. There is one big
restriction when it comes to BLE connections. Having more than one
connection as a peripheral can degrade mesh performance and lead to
connection losses. Using one connection as a peripheral and up to three
connections as a central has proven a good configuration for mesh
connections. With these settings, the following will lead to problems
where two nodes are not able to connect to each other because their one
connection as a peripheral is already taken.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="_images/mesh-overview.png" alt="impossible"></span></p>
</div>
<div class="paragraph">
<p>There is no way to know the size - or the participating nodes - of a
mesh in advance. Distributing the presence of a node over long distances
would be a bad idea because of the time it takes and the energy it
costs. This means that every node can only see its surroundig nodes.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_simulator"><a class="anchor" href="#_simulator"></a>Simulator</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There is a <a href="Simulator.html" class="page">Simulator</a> available that
illustrates how the algorithm works. It allows to apply
different configurations and see how the mesh reacts.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_node"><a class="anchor" href="#_node"></a>Node</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Each node saves a few variables like network ID, cluster ID,
cluster size and its own ID. Additionally, it keeps some information for
each of its connections.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="_images/node-data.png" alt="saved values"></span></p>
</div>
<div class="paragraph">
<p>During discovery, it broadcasts its <em>nodeId</em>, <em>clusterSize</em> and <em>clusterId</em>
along with a few other measures in special advertising packets (<a href="Specification.html" class="page">JOIN_ME</a>&gt;&gt; packets).
It also scans for some time to receive
discovery packets of surrounding nodes. From these packets, it selects
the best connection partner and establishes a connection to it.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_clustering"><a class="anchor" href="#_clustering"></a>Clustering</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The real trick here is the clustering. Because every
node knows the size of the cluster that it&#8217;s part of, it uses this information
as a criteria when connecting to others. Big clusters can always decide to
which nodes they want to connect and smaller clusters will have to obey.
Any change in cluster size due to connection or disconnection is
broadcast through the exisiting connections.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="_images/clustering.png" alt="cluster forming"></span></p>
</div>
<div class="paragraph">
<p>After a few <a href="Specification.html#<em>JOIN_ME_Packet</em>(MessageType_1)" class="page">JOIN_ME</a> packets
have been collected, they are processed in the ClusterScore function to
determine the best connection partner. A node never tries to connect
to a node with the same <em>clusterId</em> to prevent loops.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_handshake"><a class="anchor" href="#_handshake"></a>Handshake</h2>
<div class="sectionbody">
<div class="paragraph">
<p>After receiving the <a href="Specification.html#<em>JOIN_ME_Packet</em>(MessageType_1)" class="page">JOIN ME</a> packets, some time has passed
and the other node might already be in another cluster or in a different
state than before. This is why the two nodes will first do a handshake
after connecting to pass the latest information to each other. Only
one Handshake must happen at a time to prevent race conditions. Once
they are satisfied with their partner, the connection is used,
otherwise it is disconnected.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_states"><a class="anchor" href="#_states"></a>States</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The algorithm uses a state machine that switches between
different DISCOVERY and HANDSHAKE states. This helps the node to reduce
its energy usage.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_self_healing"><a class="anchor" href="#_self_healing"></a>Self-Healing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Once a connection in the cluster breaks up, the smaller
cluster distributes a new cluster ID among its nodes. This
repairs the missing connection using a similar path.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="_images/self-healing.png" alt="Self healing"></span></p>
</div>
<div class="paragraph">
<p>After each connection loss, a node will increment its
connection-loss-counter. This counter is used together with the <em>nodeId</em>
to generate a <em>clusterId</em>. This is necessary because there might be cases
where the original node of a cluster can&#8217;t join the cluster anymore if
it generates the same <em>clusterId</em> again.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_connection"><a class="anchor" href="#_connection"></a>Connection</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Master Bit:  Because a node can&#8217;t always know for certain if it is
part of the bigger cluster, there may be times when two
connected nodes both think they are part of the bigger cluster. This
would pose a threat to the mesh once the connection drops. Therefore,
each connection is assigned a <em>masterBit</em> that is passed to the node that
is part of the bigger cluster. With this, it is only possible that the
<em>masterBit</em> is in transition during a disconnect and both cluster must
dissolve, but they can no longer form any islands.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_more"><a class="anchor" href="#_more"></a>More</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Anybody interested in a much more detailed explanation of the
algorithm is welcome to take a look at
<a href="The-Algorithm-in-Detail.html" class="page">The Algorithm in Detail</a> page.</p>
</div>
</div>
</div>
</article>
<aside class="article-aside hidden" role="navigation">
  <h3 class="toc-title">FruityMesh Algorithm</h3>
  <div id="article-toc"></div>
</aside>
  </main>
</div>
  <footer class="footer fruitymesh-footer-padding">
<p>This project is under active development at the <a href="http://www.mwaysolutions.com/" >M-Way Solutions GmbH,</a> Germany.</p>
<p>We use FruityMesh ourselves in conjunction with our custom MeshGateway to build services such as connected lights, asset tracking and much more for our customers.</p>
</footer>
<script type="text/javascript">
  window.antora = window.antora || {}
  window.antora.basePath = '..'
  window.antora.pagePath = '/fruitymesh/The-FruityMesh-Algorithm.html'
</script>
<script src="../_/js/site.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lunr.js/2.3.6/lunr.min.js"></script>
<script src="../_/js/vendor/search.js"></script>
<script async src="../_/../search-index.js"></script>
<script src="../_/js/vendor/highlight.js"></script>
<script src="../_/js/vendor/zoom.js"></script>
<script>hljs.initHighlighting()</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.1.1/tocbot.min.js"></script>
<script>
  tocbot.init({
    tocSelector: '#article-toc',
    contentSelector: 'article',
    headingSelector: 'h2, h3, h4, h5, h6',
    collapseDepth: 6,
    positionFixedSelector: '#article-toc',
    scrollSmooth: true,
  });
  var tocList = document.getElementById('article-toc').getElementsByClassName('toc-list');
  if (tocList && tocList.length > 0 && tocList[0].childNodes.length > 0) {
    document.getElementById('article-toc').parentNode.classList.remove('hidden');
  }
</script>
</body>

</html>
